# 运行配置文件

`snz1dpctl`命令默认以`$HOME/.snz1dp`目录为开始目录，其目录结构如下：

- bin    程序文件目录
- config 配置文件目录
- bundle 组件文件目录
- logs   操作日志目录
- run    组件数据目录

因此默认的运行配置文件位置为：`$HOME/.snz1dp/config/global.yaml`。

> 默认的主目录可以通过`SNZ1DP_HOME`环境变量配置，也可以在给`snz1dpctl`命令添加`--base-dir`参数指定。

## 1、文件结构

### 1.1、全局配置

#### 1.1.1、配置加密

> 不设置则使用内置密码

```yaml
encryption:
  password: "配置文件加密密码"
```

#### 1.1.2、K8s环境配置

> 独立运行可省略

```yaml

# ---------------------------------
# K8s环境配置
kubernetes:
  # ---------------------------------
  # 使用文件配置K8s
  config: "K8s配置文件地址"
  # 使用令牌配置K8s
  token: "K8s访问令牌"
  server: "K8s服务器(API)"
  # ---------------------------------
  context: "K8s上下文"
  storageclass: "持久化存储类"

```

#### 1.1.3、服务地址配置

```yaml

snz1dp:
  version: "1.0-alpha"
  namespace: "K8s安装名字空间"
  # ---------------------------------
  # 服务发布API网关配置
  ingress:
    host: "对外访问域名或IP（必须设置）"
    protocol: "对外访问协议（https或http，建议https）"
  timezone: "缺省时区，默认为：Asia/Shanghai"
  organization: "组织名称"
  admin:
    username: "管理员用户名，默认为：root"
    # ---------------------------------
    # 密码只要设置其中一个，为空时随机生成
    password: "管理密码"
    encoded_password: "加密密码"
    # ---------------------------------
    email: "默认管理员邮箱"
  registry:
    # 默认镜像仓库地址
    url: snz1.cn
    # 是否SSL方式
    secure: true
    # 镜像仓库登录用户名
    username: deploy
    # ---------------------------------
    # 密码只要设置其中一个，为空时随机生成
    password: "明文密码"
    encoded_password: "加密密码"
    # ---------------------------------
  # 缺省跳转地址
  # default: ""
  # 登录视图地址
  # login: ""
  # 注销跳转地址
  # logout: ""
```

#### 1.1.4、模板参数配置

```yaml
values:
  - name: value
  # - ... 可以配置多个
```

> 此处配置的变量可以在组件配置中使用`{{ .Values.name }}`模板语法引用参数。


#### 1.1.5、附加仓库配置

```yaml

# ---------------------------------
# 多个仓库配置
docker:
- registry:
  # 默认镜像仓库地址
  url: snz1.cn
  # 是否SSL方式
  secure: true
  # 镜像仓库登录用户名
  username: deploy
  # ---------------------------------
  # 密码只要设置其中一个，为空时随机生成
  password: "明文密码"
  encoded_password: "加密密码"
  # ---------------------------------

```

### 1.2、组件配置

在配置文件中主要有两类组件：

- ***内置组件***：云原生开发技术平台内置组件，已明确依赖关系。
- ***扩展组件***：其他云原生扩展组件，根据添加顺序启动。

#### 1.2.1、内置组件配置

***数据库***

```yaml

# ---------------------------------
# PostgresQL数据库
postgres:
  # 是否安装
  install: true
  # 安装版本
  version: "9.6"

  # ---------------------------------
  # 数据库管理用户
  admin:
    username: postgres
    # ---------------------------------
    # 密码只要设置其中一个，为空时随机生成
    password: "管理密码"
    encoded_password: "加密密码"
    # ---------------------------------

  # ---------------------------------
  # 数据库服务地址，install为false时生效
  host: postgres
  # 数据库服务端口，install为false时生效
  port: 5432
  #---------------------------------

  #---------------------------------
  # 运行时参数配置
  config:
    # 运行环境变量，可以使用{{ .Values.name }}参数替换
    # envs:
    # - name: value
    # - ...

    # 停用宿主端口绑定
    # port: "disabled"

    # 自定义端口绑定，默认使用内置
    # bind:
    # - port1:port1/tcp
    # - port2:port2/udp
    # hosts:
    # - host1:ip1
    # - host2:ip2

    # kubernetes: | # K8s运行配置
    #   ...
    # standalone: | # 独立运行配置
    #   ...
  #---------------------------------


```

***高速缓存***

```yaml

#---------------------------------
# Redis缓存
redis:
  # 是否安装
  install: true
  # 安装版本
  version: 4.0.11
  # ---------------------------------
  # 密码只要设置其中一个，为空时随机生成
  password: "管理密码"
  encoded_password: "加密密码"
  # ---------------------------------
  # Redis服务地址，install为false时生效
  host: redis
  # Redis服务端口，install为false时生效
  port: 6379
  # ---------------------------------

  #---------------------------------
  # 运行时参数配置
  config:
    # 运行环境变量，可以使用{{ .Values.name }}参数替换
    # envs:
    # - name: value
    # - ...

    # 停用宿主端口绑定
    # port: "disabled"

    # 自定义端口绑定，默认使用内置
    # bind:
    # - port1:port1/tcp
    # - port2:port2/udp
    # hosts:
    # - host1:ip1
    # - host2:ip2

    # kubernetes: | # K8s运行配置
    #   ...
    # standalone: | # 独立运行配置
    #   ...
  #---------------------------------

```

***配置服务***

```yaml

#---------------------------------
# 动态配置服务
confserv:
  # 是否安装
  install: true
  # 安装版本
  version: 2.0.3
  # ---------------------------------
  # 服务地址及端口，install为false时生效
  web:
    host: confserv
    port: 80
    # ---------------------------------
    # webroot: "服务上下文目录，默认为/appconfig"
    # protocol: "访问协议（https或http，建议https，默认为http）"

  #---------------------------------
  # 运行时参数配置
  config:
    # 运行环境变量，可以使用{{ .Values.name }}参数替换
    # envs:
    # - name: value
    # - ...

    # 停用宿主端口绑定
    # port: "disabled"

    # 自定义端口绑定，默认使用内置
    # bind:
    # - port1:port1/tcp
    # - port2:port2/udp
    # hosts:
    # - host1:ip1
    # - host2:ip2

    # kubernetes: | # K8s运行配置
    #   ...
    # standalone: | # 独立运行配置
    #   ...
  #---------------------------------

```

***认证服务***

```yaml

#---------------------------------
# 认证服务
xeai:
  # 是否安装
  install: true
  # 安装版本
  version: 2.3.12
  # ---------------------------------
  # 服务地址及端口，install为false时生效
  web:
    host: xeai
    port: 80
    # ---------------------------------
    # webroot: "服务上下文目录，默认为/xeai"
    # protocol: "访问协议（https或http，建议https，默认为http）"

  # ---------------------------------
  # 请求身份令牌配置，默认使用API网关令牌
  # jwt:
  #   rsakey: | # RSA私钥
  #     ...
  #   token: "授权令牌"

  #---------------------------------
  # 运行时参数配置
  config:
    # 运行环境变量，可以使用{{ .Values.name }}参数替换
    # envs:
    # - name: value
    # - ...

    # 停用宿主端口绑定
    # port: "disabled"

    # 自定义端口绑定，默认使用内置
    # bind:
    # - port1:port1/tcp
    # - port2:port2/udp
    # hosts:
    # - host1:ip1
    # - host2:ip2

    # kubernetes: | # K8s运行配置
    #   ...
    # standalone: | # 独立运行配置
    #   ...
  #---------------------------------

```

***API网关***

```yaml

# ---------------------------------
# API网关
appgateway:
  # 是否安装
  install: true
  # 安装版本
  version: 2.0.4-1009
  # ---------------------------------
  # 管理接口地址配置，install为false时候
  admin:
    # 管理后台主机
    host: localhost
    # port: 91
    # ---------------------------------
    # webroot: "服务上下文目录，默认为空"
    # protocol: "访问协议（https或http，建议https，默认为http）"

  # ---------------------------------
  # 请求管理接口身份令牌配置，安装时自动生成
  # jwt:
  #   rsakey: | # RSA私钥
  #     ...
  #   token: "授权令牌"

  #---------------------------------
  # 运行时参数配置
  config:
    # 运行环境变量，可以使用{{ .Values.name }}参数替换
    # envs:
    # - name: value
    # - ...

    # 停用宿主端口绑定
    # port: "disabled"

    # 自定义端口绑定，默认使用内置
    # bind:
    # - port1:port1/tcp
    # - port2:port2/udp
    # hosts:
    # - host1:ip1
    # - host2:ip2

    # kubernetes: | # K8s运行配置
    #   ...
    # standalone: | # 独立运行配置
    #   ...
  #---------------------------------

```

> 你可以通过以下命令获得基本的内置组件配置：

```bash
snz1dpctl profile setup production && snz1dpctl profile export
```

#### 1.1.2、扩展组件配置

```yaml

# ---------------------------------
# 扩扩展组件必须在apps节点下
apps:
- name: "扩展组件名称"
  # 是否安装
  install: true
  # 安装版本，需要与安装包内的版本保持一致
  version: 1.0.0
  # 安装到k8s的名字空间
  namespace: appns
  # 扩展服务组件URL地址
  url: path_of_package

  # ---------------------------------
  # 请求身份令牌配置，默认使用API网关令牌
  # jwt:
  #   rsakey: | # RSA私钥
  #     ...
  #   token: "授权令牌"

  #---------------------------------
  # 运行时参数配置
  config:
    # 运行环境变量，可以使用{{ .Values.name }}参数替换
    # envs:
    # - name: value
    # - ...

    # 停用宿主端口绑定
    # port: "disabled"

    # 自定义端口绑定，默认使用内置
    # bind:
    # - port1:port1/tcp
    # - port2:port2/udp
    # hosts:
    # - host1:ip1
    # - host2:ip2

    # kubernetes: | # K8s运行配置
    #   ...
    # standalone: | # 独立运行配置
    #   ...
  #---------------------------------

```

> 通常使用`snz1dpctl`命令添加一个组件，如下所示：

```bash
snz1dpctl profile add <组件URL>
```

## 2、全局参数

在配置文件中，以`values`作为全局参数配置节点，如下所示：

```yaml
values:
  foo:
    data: 参数值
```

> 全局全局参数可通过模板方式进行引用：

```yaml
{{ .Values.foo.data }}
```

> 具体如下配置示例：

```yaml
# ---------------------------------
# 全局参数
values:
  mosquitto:
    admin:
      username: admin
      password: 123456
apps:
# ---------------------------------
# 添加服务组件
- install: true
  name: mkbridge
  namespace: snz1dp-system
  url: https://snz1.cn/download/snz1dp/mkbridge-1.0.0.tar.gz
  version: 1.0.0
  # ---------------------------------
  # 环境变量使用全局参数模板
  config:
    envs:
    - MQTT_USERNAME={{ .Values.mosquitto.admin.username }}
    - MQTT_PASSWORD={{ .Values.mosquitto.admin.password }}
```

## 3、示例配置

```yaml

# 运行配置
snz1dp:
  # 版本
  version: 1.0-alpha
  # K8s默认安装名字空间
  namespace: snz1dp-system # 安装的名字空间

  # API网关发布配置
  ingress:
    # 对外访问域名或IP（必须设置）
    host: localhost
    # 对外访问协议（https或http，建议https）
    protocol: http
    # 平台Docker镜像仓库地址配置
    docker:
      repo:
        # 镜像仓库地址
        host: repo.docker
        # 对外访问协议（https或http，建议https）
        protocol: http

  # 缺省时区
  timezone: Asia/Shanghai
  # 组织名称
  organization: "ChangSha SNZ1"
  # 默认管理员
  admin:
    # 用户名
    username: root
    # 电子邮箱
    email: root@localhost.com
    # 初始化密码，不设置会随机生成
    # password: changeme

# 数据库
postgres:
  # 数据库版本
  version: "9.6"
  # 是否安装
  install: true
  # 数据库管理用户
  admin:
    # 用户名
    username: postgres
    # 数据库密码，安装时不设置会随机生成，不安装则必须指明
    # password: postgres
  # 数据库主机名，不安装则必须指明
  host: postgres
  # 数据库访问端口，不安装则必须指明，默认5432
  port: 5432

# 高速缓存
redis:
  # 版本
  version: 4.0.11
  # 是否安装
  install: true
  # 访问密码，安装时不设置会随机生成，不安装则必须指明
  # password: redis
  # Redis主机地址，不安装则必须指明
  host: redis
  # Redis访问端口，不安装则必须指明，默认5432
  port: 6379

# API网关
appgateway:
  version: 2.0.4-1009
  install: true

# 配置服务
confserv:
  version: 2.0.3
  install: true

# 身份认证
xeai:
  version: 2.5.6-426
  install: true
```
