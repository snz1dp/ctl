# 组件开发配置

> 使用`snz1dpctl`工具可以辅助实现组件的云原生方式打包、实现开发运行依赖环境的快速准备。
> 要求已安装好`Docker`环境。

工具约定组件开发工程都必须在其目录包含一个`BUILD.yaml`文件，主要包括以下几段内容：

- 编译配置
- 开发依赖

## 1、编译配置文件

***编译类型***

```yaml
type: maven
```

> 可选值：`maven`、`vue`等。

***组件名称***

```yaml
name: gateway-dashweb
```

> 名称必须符合目录名称规范。

***组件描述***

```yaml
description: "description of component"
```

***组件版本***

```yaml
version: 1.0.0-513
```

> 省略时从工程目录的`VERSION`文件中加载。

***组件分类***

```yaml
catelog: application
```

> 打包后的`chart`组件类型，默认为「application」

***目标镜像***

```yaml

docker:
  # 镜像名称
  image: snz1.cn/appgateway/dashweb
  # 镜像编译文件(默认：Dockerfile)
  file: Dockerfile
  # 镜像编译参数，应用于docker build --build-arg
  args:
    # arg1: val2
    # arg2: val2
  # 镜像编译参数，应用于docker build --tag
  labels:
    # label1: value1
    # label2: value2

```

***服务定义***

```yaml
service:

  # 文件及目录卷配置
  volumes:
  # - data:/path/of/container/dir
  # - file:/path/of/container/file

  # 主机名及IP配置，可以使用配置模板变量
  hosts:
  # - name=ipaddr

  # 定义绑定端口，应用于docker run -p
  # 后缀/tcp或/udp省略时
  # 默认定义为tcp端口
  ports:
  # - 80:80/tcp
  # - 80:81/udp

  # 内置文件，可以使用配置模板变量
  # files:
  #   file1: content of file1

  # 环境变量，可以使用配置模板变量
  # envs:
  # - name=xxxxx

  # 定义入口命令，可以使用配置模板变量
  # command:
  # - cmd
  # - and
  # - arg1
  # - arg2

  # 定义初始化命令，可以使用配置模板变量
  # init:
  # - cmd
  # - and
  # - arg1
  # - arg2

  # 心跳检查
  healthcheck:
    # 心跳检查URL
    # 如果带协议、主机名、端口则
    # 默认使用ports定义中第一个端口进行拼接。
    url: /health
    # 心跳检查命令，与url二选一
    # test:
    # - cmd
    # - of
    # - health
    # - check

    # 心跳检查间隔时间
    interval: 6s
    # 心跳检查超时时间
    timeout: 10s
    # 心跳检查启动时间
    period: 30s
    # 不健康重试次数
    retries: 3

  # 路由定义列表
  ingress:
    # 协议类型，默认为http，可选值https、tcp
  - protocol: http
    # 服务端口定义，默认为协议的标准端口
    backend-port: 80

    # 是否向后传递请求域名，默认为true
    # preserve-host: true

    # 是否去除注册的路径前缀，默认为false
    # strip-path: false

    # 读取超时定义，默认60000毫秒
    # read-timeout: 60000

    # 写入超时定义，默认60000毫秒
    # write-timeout: 60000

    # 后台服务入口地址，默认为“”
    # webroot: /demo

    # 前端认证服务接口列表
    # sso:
    # - /demo/webfront/api

    # 前端认证服务接口匿名可达，默认为false
    # misc: false

    # 后台认证服务接口列表
    # jwt:
    # - /demo/backend/api

    # 匿名开放服务接口列表
    # anonymous:
    # - /demp/anonymous/api

    # 自定义登录页面配置
    # login:
    #   # 应用访问地址
    #   path: /path/of/user/page
    #   # 自定义登录页面
    #   page: /path/of/login/page
    #   # 是否仅页面视图，默认为false
    #   view: false

```

## 2、开发依赖配置

在`BUILD.yaml`文件中还一部分配置属于开发运行时配置，通常用于简化服务组件的依赖组件配置，内容结构如下：

```yaml

develop:
  config: |
    运行配置文件内容...

  # 开发调试服务调用身份配置
  jwt:
    token: xxxxx
    rsakey: |
      PEM格式的RSA文件内容...

```

其中「运行配置文件内容」本质是「[运行配置文件](./2.运行配置文件.md)」，通过此段配置可以快速在开发机器上准备好运行依赖环境，如下命令：

```bash
snz1dpctl make standalone develop
```

> 该命令是把`develop.config`内容设置为默认的「运行配置文件」，然后独立运行方式启动配置中的服务组件。