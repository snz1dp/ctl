# 命令操作指南

`snz1dpctl`命令工具，是用来简化云原生开发依赖运行时管理，同时提供云原生打包、运行、测试、发布的标准简化组件打包配置定义。

> 要求已安装好`Docker`环境。


## 1、命令工具下载与安装

### 1.1、Linux或MacOS下安装

`Linux`或`MacOS`环境请新开一个`bash`或`zsh`终端，然后执行以下命令准备目录并下载文件：

```bash
OS=$(uname|tr '[:upper:]' '[:lower:]')
mkdir -p $HOME/.snz1dp/bin

wget -O $HOME/.snz1dp/bin/snz1dpctl \
  https://snz1.cn/download/snz1dp/snz1dpctl-${OS}-amd64

chmod +x  $HOME/.snz1dp/bin/snz1dpctl
```

等待命令执行完成之后把`$HOME/.snz1dp/bin`目录加入可执行文件搜索目录`PATH`环境变量中：

```bash
echo export PATH=\"\$PATH:$HOME/.snz1dp/bin\">>~/.bash_profile
export PATH="$PATH:$HOME/.snz1dp/bin"
```

如果一切正常，新开一个终端可以使用以下命令查看版本：

```bash
snz1dpctl version
```

***手动下载地址***

- [Linux amd64](https://snz1.cn/download/snz1dp/snz1dpctl-linux-amd64)
- [MacOS amd64](https://snz1.cn/download/snz1dp/snz1dpctl-darwin-amd64)


### 1.2、Windows下安装

开始之前新开一个命令行（`cmd.exe`）先使用以下命令创建所需目录：

```cmd
mkdir %HOMEDRIVE%\%HOMEPATH%\.snz1dp\bin
```

然后下载[Windows amd64版本](https://snz1.cn/download/snz1dp/snz1dpctl-windows-amd64.exe)
文件并更名为`snz1dpctl.exe`，复制到`%HOMEDRIVE%\%HOMEPATH%\.snz1dp\bin`目录中。

然后打开控【制面板\系统和安全\系统\高级设置】并点击【环境变量】按钮，如下图所示：

![环境变量](./img/windows-env.jpg)

选中用户环境变量中的`Path`条目并点击【编辑】按钮，如下图所示：

![编辑变量](./img/windows-env-edit.png)

在对话框中点击【新建】按钮，填入``后点击【确认】按钮，如下所示：

![添加变量](./img/windows-env-save.png)

如果一切正常，新开一个命令行可以使用以下命令查看版本：

```cmd
snz1dpctl version
```

## 2、命令主要功能

`snz1dpctl`命令主要有以下功能：

- profile     运行配置管理命令
- bundle      组件文件管理命令
- standalone  独立运行组件命令
- create      工程组件创建命令
- k8s         K8s运行组件命令
- make        工程组件构建命令
- ingress     API网关管理命令
- upgrade     升级工具本身命令
- version     工具环境版本命令

> 任何一个子命令都可以使用`-h`查看帮助说明。

## 3、运行配置管理

`snz1dpctl profile`命令是运行配置管理功能，有以下子命令功能：

- setup       使用模板设置运行配置文件
- list        列出当前运行配置中的组件
- add         在运行配置文件中添加组件
- remove      从运行配置文件中移除组件
- export      导出运行配置文件内容详情
- show        显示当前运行配置文件内容
- login       登录当前运行配置镜像仓库

### 3.1、使用模板设置运行配置文件

> 使用默认内置配置初始化：

```bash
snz1dpctl profile setup <minimal | normal | production>
```

- minimal     最小化配置，不安装任何组件
- normal      仅安装数据库、缓存、API网关
- production  安装数据库、缓存、API网关、配置服务、认证服务

> 使用外部配置文件初始化：

```bash
snz1dpctl profile setup <URL or PATH of profile file>
```

> 可以提供准备好配置文件用于快速安装。

### 3.2、列出当前运行配置中的组件

```bash
snz1dpctl profile list
```

### 3.3、在运行配置文件中添加组件

```bash
snz1dpctl profile add <NAME or URL>
```

### 3.4、从运行配置文件中移除组件

```bash
snz1dpctl profile add <NAME>
```

> 此处的`NAME`必须使用`snz1dpctl profile list`获取（不带版本）。


### 3.5、导出运行配置文件内容详情

> 命令用于导出运行配置模板

```bash
snz1dpctl profile export
```

辅助参数：

  - -d, --detail-config     输出扩展配置详情
  - -o, --output-file       指定输出目标文件
  - -p, --output-password   加密机密数据的密码
  - -t, --plain-password    不加密机密数据输出

### 3.6、显示当前运行配置文件内容

```bash
snz1dpctl profile show
```

### 3.7、登录当前运行配置镜像仓库

```bash
snz1dpctl profile login \
  --repo-url <URL> \
  --repo-username <USER> \
  --repo-password <PASS>
```
> 登录成功后自动保存仓库地址及登录用户名密码。

## 4、组件文件管理命令

包括对组件包下载、镜像加载、运行数据及日志清理、离线打包功能等，包含以下子命令：

- clean       清理组件运行数据及日志
- download    下载组件包及Docker镜像
- load        加载组件离线Docker镜像
- package     打包运行配置及依赖组件包

## 5、独立运行组件命令

独立运行组件命令用于管理在当前主机独立运行所有运行配置的服务组件，包括子命令如下：

- list        列出所有正在运行的服务组件列表
- clean       清理独立运行组件的数据文件内容
- restart     重新启动正在独立运行的服务组件
- start       以独立方式启动已配置的服务组件
- stop        停止已运行的服务组件或所有组件
- logs        查看已运行的服务组件的运行日志

## 6、K8s运行组件命令

## 7、工程组件构建命令

子命令`make`设计用来进行组件开发配置构建目的，包括以下子命令：

- build       执行当前项目的编译脚本
- clean       清理当前项目的清理脚本
- docker      执行当前项目的镜像构建
- install     执行当前项目的组件安装
- package     打包当前项目的组件配置
- publish     执行当前项目的发布脚本
- run         执行当前项目的运行脚本
- sonar       执行当前项目的Sonar脚本
- test        执行当前项目的测试脚本
- standalone  运行当前项目容器镜像

> 具体参见《[组件开发配置](./3.组件开发配置.md)》

## 8、API网关管理命令

子命令`ingress`用来配置管理API网关，包括以下子命令：

- consumer    调用身份管理
- route       服务路由管理
- service     服务定义管理
- upstream    负载均衡管理

